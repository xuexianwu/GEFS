# This file is used to generate config.fv3, which is one of two files
# used to control the forecast job.  The other file is config.fcst.
# This file sets task geometry, domain decomposition, and I/O server
# options.

config_fv3:
  filename: config.fv3
  enkf_cdmbgwd_settings: !FirstTrue
    - when: !calc ( "cdmbgwd" in doc.fv3_enkf_settings )
      do: !expand "export cdmbgwd={doc.fv3_enkf_settings.cdmbgwd}"
    - otherwise:  "# not setting cdmbgwd"
  gfs_cdmbgwd_settings: !FirstTrue
    - when: !calc ( "cdmbgwd" in doc.fv3_gfs_settings )
      do: !expand "export cdmbgwd={doc.fv3_gfs_settings.cdmbgwd}"
    - otherwise:  "# not setting cdmbgwd"
  gdas_cdmbgwd_settings: !FirstTrue
    - when: !calc ( "cdmbgwd" in doc.fv3_gdas_settings )
      do: !expand "export cdmbgwd={doc.fv3_gdas_settings.cdmbgwd}"
    - otherwise:  "# not setting cdmbgwd"
  content: !expand |
    #!/bin/ksh -x
    
    # This file is automatically generated from the YAML-based system
    # in ecf/ecfutils/.  Any changes will be overwritten if
    # setup_case.sh is rerun.
    
    ########## config.fv3 ##########
    # FV3 model resolution specific parameters
    # e.g. time-step, processor layout, physics and dynamics parameters
    # This config sets default variables for FV3 for a given resolution
    # User can over-ride after sourcing this config file
    
    if [ $# -ne 1 ]; then
    
        echo "Must specify a forecast mode to set variables!"
        echo "argument can be any one of the following:"
        echo "EFCS GFS GDAS   (upper- or lower-case is okay)"
        err_exit "Missing mandatory argument to config.fv3"
        exit 1
    
    fi
    
    forecast_mode=$( echo "$1" | tr a-z A-Z )

    case $forecast_mode in
        "GFS")    
              echo "BEGIN: config.fv3 for $forecast_mode"
              export DELTIM={doc.fv3_gfs_settings.DELTIM}
              export OCNTIM={doc.fv3_gfs_settings.OCNTIM}
              export ICETIM={doc.fv3_gfs_settings.ICETIM}
              export layout_x={doc.fv3_gfs_settings.layout.x}
              export layout_y={doc.fv3_gfs_settings.layout.y}
              export layout_x_gfs={doc.fv3_gfs_settings.layout.x}
              export layout_y_gfs={doc.fv3_gfs_settings.layout.y}
              export npe_node_fcst={doc.partition_common.resources.run_gdasfcst[0].max_ppn}
              export nth_fv3="{doc.fv3_gfs_settings.layout.nth}"
              export npe_fv3={doc.partition_common.resources.run_gdasfcst[0].mpi_ranks}
              export cdmbgwd={doc.fv3_gfs_settings.cdmbgwd}  
                       # mountain blocking and gravity wave drag
              export WRITE_GROUP={doc.fv3_gfs_settings.layout.WGRP}
              export WRTTASK_PER_GROUP={doc.fv3_gfs_settings.layout.WGRP_NTASKS}
              export WRITE_GROUP_GFS={doc.fv3_gfs_settings.layout.WGRP}
              export WRTTASK_PER_GROUP_GFS={doc.fv3_gfs_settings.layout.WGRP_NTASKS}
              export WRTIOBUF={doc.fv3_gfs_settings.layout.WRTIOBUF}
              ;;
        "GDAS")
              echo "BEGIN: config.fv3 for $forecast_mode"
              export DELTIM={doc.fv3_gdas_settings.DELTIM}
              export OCNTIM={doc.fv3_gdas_settings.OCNTIM}
              export ICETIM={doc.fv3_gdas_settings.ICETIM}
              export layout_x={doc.fv3_gdas_settings.layout.x}
              export layout_y={doc.fv3_gdas_settings.layout.y}
              export layout_x_gfs={doc.fv3_gdas_settings.layout.x}
              export layout_y_gfs={doc.fv3_gdas_settings.layout.y}
              export npe_node_fcst={doc.partition_common.resources.run_gdasfcst[0].max_ppn}
              export nth_fv3="{doc.fv3_gfs_settings.layout.nth}"
              export npe_fv3={doc.partition_common.resources.run_gdasfcst[0].mpi_ranks}
              export cdmbgwd={doc.fv3_gdas_settings.cdmbgwd}
              export WRITE_GROUP={doc.fv3_gdas_settings.layout.WGRP}
              export WRTTASK_PER_GROUP={doc.fv3_gdas_settings.layout.WGRP_NTASKS}
              export WRITE_GROUP_GFS={doc.fv3_gdas_settings.layout.WGRP}
              export WRTTASK_PER_GROUP_GFS={doc.fv3_gdas_settings.layout.WGRP_NTASKS}
              export WRTIOBUF={doc.fv3_gdas_settings.layout.WRTIOBUF}
              ;;
        "ENKF")
              echo "BEGIN: config.fv3 for $forecast_mode"
              export DELTIM={doc.fv3_enkf_settings.DELTIM}
              export OCNTIM={doc.fv3_enkf_settings.OCNTIM}
              export ICETIM={doc.fv3_enkf_settings.ICETIM}
              export layout_x={doc.fv3_enkf_settings.layout.x}
              export layout_y={doc.fv3_enkf_settings.layout.y}
              export layout_x_gfs={doc.fv3_enkf_settings.layout.x}
              export layout_y_gfs={doc.fv3_enkf_settings.layout.y}
              export npe_node_fcst={doc.partition_common.resources.run_efcs[0].max_ppn}
              export nth_fv3="{doc.fv3_gfs_settings.layout.nth}"
              export npe_fv3={doc.partition_common.resources.run_efcs[0].mpi_ranks}
              export cdmbgwd={doc.fv3_enkf_settings.cdmbgwd}
              export WRITE_GROUP={doc.fv3_enkf_settings.layout.WGRP}
              export WRTTASK_PER_GROUP={doc.fv3_enkf_settings.layout.WGRP_NTASKS}
              export WRITE_GROUP_GFS={doc.fv3_enkf_settings.layout.WGRP}
              export WRTTASK_PER_GROUP_GFS={doc.fv3_enkf_settings.layout.WGRP_NTASKS}
              export WRTIOBUF={doc.fv3_enkf_settings.layout.WRTIOBUF}
              ;;
          *)
              echo "CDUMP undefined!"
              exit 2
    esac 
    echo "END: config.fv3 for $forecast_mode"
